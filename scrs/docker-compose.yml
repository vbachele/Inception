version: '3'

services:
  nginx:
    container_name: nginx
    depends_on:
      - adminer
      - wordpress
    build: ./requirements/nginx
    ports:
      - 443:443
    volumes:
      - wordpress_data:/var/www/html
    restart: always
    networks:
      - network

  mariadb:
    container_name: mariadb
    build: ./requirements/mariadb
    #volumes allow to store in a persistent disk the content in a local disk
    #db_data is a volume created by docker directly
    volumes:
      - mariadb_data:/var/lib/mysql
    # in case of problem we restart automatically the container
    networks:
      - network
    ports:
      - 3306:3306
    restart: always
    env_file:
      - .env

  wordpress:
    container_name: wordpress
    #Create a depedency between the 2 container, db will be launched before
    depends_on:
      - mariadb
    build:
      context: ./requirements/wordpress
      dockerfile: dockerfile
    restart: always
    env_file:
      - .env
    ports:
     - 9000:9000
    volumes:
      - wordpress_data:/var/www/html
    networks:
      - network

#BONUS PART
  redis:
    container_name: redis
    build: ./requirements/bonus/redis
    depends_on:
      - wordpress
    ports:
     - '6379:6379'
    restart: always
    env_file:
      - .env
    networks:
      - network

  # ftp-server:
  #   build: requirements/bonus/ftp_server
  #   container_name: ftp-server
  #   ports:
  #     - "21:21"
  #     - "21100-21110:21100-21110"
  #   volumes:
  #     - "wordpress_data:/var/www/html"
  #   networks:
  #     - network
  #   restart: always
  #   environment:
  #     FTP_USR: ${FTP_USR}
  #     FTP_PWD: ${FTP_PWD}

  adminer:
    build: 
      context: ./requirements/bonus/adminer
      args:
        - USER_ID=${USER_ID}
        - GROUP_ID=${GROUP_ID}
    container_name: adminer
    restart: always
    healthcheck:
      test: netstat -an | grep 9042 > /dev/null; if [ 0 != $$? ]; then exit 1; fi;
      interval: 10s
      start_period: 10s
    networks: ['network']
  # adminer:
  #   build: ./requirements/bonus/adminer
  #   restart: always
  #   depends_on:
  #     - mariadb
  #   expose:
  #    - "9000"
  #   networks:
  #     - network
  #   volumes:
  #     - wordpress_data:/var/www/html
  #   healthcheck:
  #     test: netstat -an | grep 9000 > /dev/null; if [ 0 != $$? ]; then exit 1; fi;
  #     interval: 10s
  #     start_period: 10s

volumes:
  mariadb_data:
    driver: local
    # driver_opts:
    #   type: none
    #   device: /home/vbachele/data/mysql
    #   o: bind
  wordpress_data:
    driver: local
    # driver_opts:
    #   type: none
    #   device: /home/vbachele/data/wordpress
    #   o: bind

networks:
  network:
    driver: bridge